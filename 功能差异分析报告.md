# 香河香草中医诊所平台功能差异分析报告

## 概述
本报告详细分析了 CLAUDE.md 文档中描述的功能需求与当前代码实现的差异。

## 一、已实现的功能

### 1. 基础模型
- ✅ User (用户基础信息)
- ✅ Doctor (医生信息)
- ✅ Appointment (预约信息)
- ✅ Prescription (处方信息)
- ✅ LiveStream (直播信息)
- ✅ CirclePost (圈子帖子)

### 2. 已实现的API控制器
- ✅ AuthController (认证控制器)
- ✅ UserController (用户控制器)
- ✅ DoctorController (医生控制器)
- ✅ AppointmentController (预约控制器)
- ✅ PrescriptionController (处方控制器)

### 3. 已实现的服务层
- ✅ AuthService
- ✅ UserService
- ✅ DoctorService
- ✅ AppointmentService
- ✅ PrescriptionService

## 二、文档中提到但代码中未实现的功能

### 1. 缺失的模型

#### 1.1 科室管理模型
```rust
// 需要添加的模型
Department {
    id: String,
    name: String,           // 科室名称
    code: String,           // 科室编码（如：ZY001）
    contact_person: String, // 联系人
    contact_phone: String,  // 联系电话
    description: String,    // 科室描述
    status: String,         // 状态
    created_at: Date,
    updated_at: Date
}
```

#### 1.2 内容管理模型
```rust
// 新闻/文章模型
Article {
    id: String,
    title: String,          // 标题
    cover_image: String,    // 封面图（310x298px）
    content: String,        // 内容
    author_id: String,      // 作者ID
    channel: String,        // 发布渠道
    status: String,         // 状态：draft/published
    views: Number,          // 浏览量
    created_at: Date,
    updated_at: Date
}

// 视频模型
Video {
    id: String,
    title: String,          // 标题
    description: String,    // 描述
    video_url: String,      // 视频地址
    thumbnail: String,      // 缩略图
    duration: Number,       // 时长（秒）
    author_id: String,      // 上传者ID
    status: String,         // 状态
    created_at: Date,
    updated_at: Date
}
```

#### 1.3 患者管理模型
```rust
// 患者分组
PatientGroup {
    id: String,
    doctor_id: String,      // 医生ID
    group_name: String,     // 分组名称
    patient_ids: Array,     // 患者ID列表
    created_at: Date,
    updated_at: Date
}

// 患者评价
PatientReview {
    id: String,
    patient_id: String,     // 患者ID
    doctor_id: String,      // 医生ID
    appointment_id: String, // 预约ID
    rating: Number,         // 评分（1-5）
    comment: String,        // 评价内容
    created_at: Date
}
```

#### 1.4 医生个人设置模型
```rust
// 常用语设置
CommonPhrase {
    id: String,
    doctor_id: String,      // 医生ID
    phrase_type: String,    // 类型：greeting/diagnosis/advice
    content: String,        // 内容
    created_at: Date
}

// 常用处方模板
PrescriptionTemplate {
    id: String,
    doctor_id: String,      // 医生ID
    template_name: String,  // 模板名称
    diagnosis: String,      // 诊断
    medicines: Array,       // 药品列表
    instructions: String,   // 用药说明
    created_at: Date
}
```

#### 1.5 圈子管理模型
```rust
// 圈子信息
Circle {
    id: String,
    name: String,           // 圈子名称
    description: String,    // 描述
    creator_id: String,     // 创建者ID
    member_count: Number,   // 成员数
    post_count: Number,     // 帖子数
    status: String,         // 状态
    created_at: Date
}

// 圈子成员
CircleMember {
    id: String,
    circle_id: String,      // 圈子ID
    user_id: String,        // 用户ID
    role: String,           // 角色：owner/admin/member
    joined_at: Date
}
```

#### 1.6 就诊人管理模型
```rust
// 就诊人信息
PatientProfile {
    id: String,
    user_id: String,        // 所属用户ID
    name: String,           // 姓名
    id_number: String,      // 身份证号
    phone: String,          // 手机号
    relationship: String,   // 关系：self/family/friend
    is_default: Boolean,    // 是否默认
    created_at: Date
}
```

### 2. 缺失的控制器和服务

#### 2.1 内容管理相关
- ❌ ArticleController / ArticleService
- ❌ VideoController / VideoService
- ❌ ContentChannelController

#### 2.2 直播功能相关
- ❌ LiveStreamController
- ❌ LiveStreamService

#### 2.3 圈子社区相关
- ❌ CircleController / CircleService
- ❌ CirclePostController / CirclePostService
- ❌ CircleMemberController

#### 2.4 科室管理相关
- ❌ DepartmentController / DepartmentService

#### 2.5 患者管理相关
- ❌ PatientGroupController / PatientGroupService
- ❌ PatientReviewController / PatientReviewService
- ❌ PatientProfileController / PatientProfileService

#### 2.6 医生个人设置相关
- ❌ CommonPhraseController / CommonPhraseService
- ❌ PrescriptionTemplateController / PrescriptionTemplateService

### 3. 缺失的具体业务功能

#### 3.1 管理端功能
1. **组织架构管理**
   - ❌ 批量用户操作（删除、导出）
   - ❌ 权限分配（授权角色、授权数据）
   - ❌ 科室信息维护
   - ❌ 科室编码规则管理

2. **业务管理**
   - ❌ 号源管理（挂号记录查询、状态跟踪）
   - ❌ 内容发布管理
   - ❌ 视频管理（上传、审核）
   - ❌ 直播管理（查看记录、二维码生成）

#### 3.2 医生端功能
1. **数据看板**
   - ❌ 今日已接诊数统计
   - ❌ 今日已预约数统计
   - ❌ 今年总预约数统计
   - ❌ 今年总接诊数统计

2. **核心功能**
   - ❌ 今日问诊分类查看（全部、待接诊、进行中、已完成）
   - ❌ 患者分组功能（最多5个分组）
   - ❌ 群发消息功能
   - ❌ 常用语/常用处方设置
   - ❌ 患者评价查看

3. **内容发布**
   - ❌ 文章撰写（写作指南）
   - ❌ 直播预告发布
   - ❌ 视频问诊录制上传

#### 3.3 患者端功能
1. **首页功能**
   - ❌ 品牌展示模块
   - ❌ 快捷入口组件
   - ❌ 医生推荐算法

2. **就医服务**
   - ❌ 视频问诊功能
   - ❌ 处方历史追溯
   - ❌ 就诊人管理
   - ❌ 设置默认就诊人

3. **互动功能**
   - ❌ 直播观看功能
   - ❌ 直播提醒设置
   - ❌ 圈子加入/退出
   - ❌ 敏感词过滤
   - ❌ 内容举报功能

### 4. 缺失的API端点

#### 4.1 内容管理API
```
POST   /api/v1/articles              # 创建文章
GET    /api/v1/articles              # 获取文章列表
GET    /api/v1/articles/:id          # 获取文章详情
PUT    /api/v1/articles/:id          # 更新文章
DELETE /api/v1/articles/:id          # 删除文章

POST   /api/v1/videos                # 上传视频
GET    /api/v1/videos                # 获取视频列表
GET    /api/v1/videos/:id            # 获取视频详情
DELETE /api/v1/videos/:id            # 删除视频
```

#### 4.2 直播管理API
```
POST   /api/v1/live-streams           # 创建直播
GET    /api/v1/live-streams           # 获取直播列表
GET    /api/v1/live-streams/:id       # 获取直播详情
PUT    /api/v1/live-streams/:id       # 更新直播状态
POST   /api/v1/live-streams/:id/qr    # 生成直播二维码
```

#### 4.3 圈子社区API
```
POST   /api/v1/circles                # 创建圈子
GET    /api/v1/circles                # 获取圈子列表
POST   /api/v1/circles/:id/join       # 加入圈子
POST   /api/v1/circles/:id/leave      # 退出圈子

POST   /api/v1/circle-posts           # 发布帖子
GET    /api/v1/circle-posts           # 获取帖子列表
POST   /api/v1/circle-posts/:id/like  # 点赞帖子
POST   /api/v1/circle-posts/:id/comment # 评论帖子
```

#### 4.4 患者管理API
```
POST   /api/v1/patient-groups         # 创建患者分组
GET    /api/v1/patient-groups         # 获取分组列表
PUT    /api/v1/patient-groups/:id     # 更新分组
POST   /api/v1/patient-groups/:id/message # 群发消息

POST   /api/v1/patient-reviews        # 提交评价
GET    /api/v1/doctors/:id/reviews    # 获取医生评价

POST   /api/v1/patient-profiles       # 添加就诊人
GET    /api/v1/patient-profiles       # 获取就诊人列表
PUT    /api/v1/patient-profiles/:id/default # 设置默认就诊人
```

#### 4.5 统计分析API
```
GET    /api/v1/doctors/:id/statistics # 医生数据统计
GET    /api/v1/doctors/:id/today-stats # 今日数据
GET    /api/v1/admin/dashboard        # 管理端仪表盘
```

### 5. 缺失的业务逻辑

#### 5.1 权限控制
- ❌ 细粒度权限控制
- ❌ 数据权限隔离
- ❌ 角色权限映射

#### 5.2 数据处理
- ❌ 敏感词过滤系统
- ❌ 图片/视频处理服务
- ❌ 二维码生成服务

#### 5.3 通知系统
- ❌ 预约提醒
- ❌ 直播提醒
- ❌ 系统通知
- ❌ 群发消息

#### 5.4 第三方集成
- ❌ 视频通话SDK集成
- ❌ 直播SDK集成（快手）
- ❌ 短信服务集成
- ❌ 支付接口集成
- ❌ 云存储集成

## 三、数据库表结构缺失

需要添加的数据库表：
1. departments (科室表)
2. articles (文章表)
3. videos (视频表)
4. patient_groups (患者分组表)
5. patient_reviews (患者评价表)
6. common_phrases (常用语表)
7. prescription_templates (处方模板表)
8. circles (圈子表)
9. circle_members (圈子成员表)
10. patient_profiles (就诊人表)
11. notifications (通知表)
12. system_config (系统配置表)

## 四、优先级建议

### 高优先级（MVP必需）
1. 完善直播功能的控制器和服务
2. 实现基础的内容管理（文章发布）
3. 添加患者分组功能
4. 实现就诊人管理
5. 添加基础统计功能

### 中优先级（功能完善）
1. 圈子社区功能
2. 视频管理功能
3. 患者评价系统
4. 常用语/处方模板
5. 通知系统

### 低优先级（后续迭代）
1. 第三方SDK集成
2. 高级权限控制
3. 数据分析报表
4. 性能优化

## 五、实施建议

1. **数据库迁移**：创建新的迁移文件，添加缺失的表结构
2. **模型层完善**：在 models 目录下添加缺失的数据模型
3. **服务层实现**：为每个业务模块创建对应的服务
4. **控制器开发**：实现 RESTful API 端点
5. **路由注册**：在 routes/mod.rs 中注册新的路由
6. **测试覆盖**：为新功能编写单元测试和集成测试

## 六、总结

当前代码实现了基础的用户认证、医生管理、预约和处方功能，但距离文档描述的完整功能还有较大差距。主要缺失：
- 内容管理系统（新闻、视频）
- 直播功能的完整实现
- 圈子社区的完整功能
- 患者管理的高级功能
- 统计分析功能
- 第三方服务集成

建议按照优先级逐步实现缺失功能，确保每个模块都有完整的测试覆盖。