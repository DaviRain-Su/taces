# 功能实施计划

## 第一阶段：数据库迁移（优先级：高）

### 1. 创建新的迁移文件
```sql
-- migrations/20240102000001_add_missing_tables.sql

-- 1. 科室表
CREATE TABLE departments (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(20) UNIQUE NOT NULL,
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    description TEXT,
    status ENUM('active', 'inactive') NOT NULL DEFAULT 'active',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_code (code)
);

-- 2. 文章表
CREATE TABLE articles (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    title VARCHAR(200) NOT NULL,
    cover_image VARCHAR(255),
    content TEXT NOT NULL,
    author_id CHAR(36) NOT NULL,
    channel ENUM('hospital_intro', 'news', 'mobile', 'health_knowledge', 'activities') NOT NULL,
    status ENUM('draft', 'published', 'deleted') NOT NULL DEFAULT 'draft',
    views BIGINT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at DATETIME,
    FOREIGN KEY (author_id) REFERENCES users(id),
    INDEX idx_author_id (author_id),
    INDEX idx_channel (channel),
    INDEX idx_status (status)
);

-- 3. 视频表
CREATE TABLE videos (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    video_url VARCHAR(255) NOT NULL,
    thumbnail VARCHAR(255),
    duration INT NOT NULL DEFAULT 0,
    file_size BIGINT NOT NULL DEFAULT 0,
    author_id CHAR(36) NOT NULL,
    status ENUM('processing', 'active', 'deleted') NOT NULL DEFAULT 'processing',
    views BIGINT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (author_id) REFERENCES users(id),
    INDEX idx_author_id (author_id)
);

-- 4. 患者分组表
CREATE TABLE patient_groups (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    doctor_id CHAR(36) NOT NULL,
    group_name VARCHAR(50) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE CASCADE,
    INDEX idx_doctor_id (doctor_id),
    UNIQUE KEY uk_doctor_group (doctor_id, group_name)
);

-- 5. 患者分组成员表
CREATE TABLE patient_group_members (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    group_id CHAR(36) NOT NULL,
    patient_id CHAR(36) NOT NULL,
    joined_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES patient_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (patient_id) REFERENCES users(id),
    UNIQUE KEY uk_group_patient (group_id, patient_id),
    INDEX idx_group_id (group_id),
    INDEX idx_patient_id (patient_id)
);

-- 6. 患者评价表
CREATE TABLE patient_reviews (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    patient_id CHAR(36) NOT NULL,
    doctor_id CHAR(36) NOT NULL,
    appointment_id CHAR(36) NOT NULL,
    rating TINYINT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (patient_id) REFERENCES users(id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(id),
    FOREIGN KEY (appointment_id) REFERENCES appointments(id),
    UNIQUE KEY uk_appointment_review (appointment_id),
    INDEX idx_doctor_id (doctor_id),
    INDEX idx_patient_id (patient_id)
);

-- 7. 常用语表
CREATE TABLE common_phrases (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    doctor_id CHAR(36) NOT NULL,
    phrase_type ENUM('greeting', 'diagnosis', 'advice', 'other') NOT NULL,
    content TEXT NOT NULL,
    sort_order INT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE CASCADE,
    INDEX idx_doctor_type (doctor_id, phrase_type)
);

-- 8. 处方模板表
CREATE TABLE prescription_templates (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    doctor_id CHAR(36) NOT NULL,
    template_name VARCHAR(100) NOT NULL,
    diagnosis TEXT NOT NULL,
    medicines JSON NOT NULL,
    instructions TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE CASCADE,
    INDEX idx_doctor_id (doctor_id)
);

-- 9. 圈子表
CREATE TABLE circles (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    creator_id CHAR(36) NOT NULL,
    member_count INT NOT NULL DEFAULT 0,
    post_count INT NOT NULL DEFAULT 0,
    status ENUM('active', 'inactive') NOT NULL DEFAULT 'active',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (creator_id) REFERENCES users(id),
    INDEX idx_creator_id (creator_id),
    INDEX idx_status (status)
);

-- 10. 圈子成员表
CREATE TABLE circle_members (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    circle_id CHAR(36) NOT NULL,
    user_id CHAR(36) NOT NULL,
    role ENUM('owner', 'admin', 'member') NOT NULL DEFAULT 'member',
    joined_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (circle_id) REFERENCES circles(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY uk_circle_user (circle_id, user_id),
    INDEX idx_circle_id (circle_id),
    INDEX idx_user_id (user_id)
);

-- 11. 就诊人表
CREATE TABLE patient_profiles (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    user_id CHAR(36) NOT NULL,
    name VARCHAR(50) NOT NULL,
    id_number VARCHAR(18) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    relationship ENUM('self', 'family', 'friend', 'other') NOT NULL,
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id)
);

-- 12. 通知表
CREATE TABLE notifications (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    user_id CHAR(36) NOT NULL,
    type ENUM('appointment', 'prescription', 'live_stream', 'system') NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id_read (user_id, is_read),
    INDEX idx_created_at (created_at)
);

-- 修改 doctors 表，添加科室关联
ALTER TABLE doctors ADD COLUMN department_id CHAR(36) AFTER department;
ALTER TABLE doctors ADD FOREIGN KEY (department_id) REFERENCES departments(id);
```

## 第二阶段：模型层实现（优先级：高）

### 需要创建的模型文件：

1. **backend/src/models/department.rs**
2. **backend/src/models/article.rs**
3. **backend/src/models/video.rs**
4. **backend/src/models/patient_group.rs**
5. **backend/src/models/patient_review.rs**
6. **backend/src/models/common_phrase.rs**
7. **backend/src/models/prescription_template.rs**
8. **backend/src/models/circle.rs**
9. **backend/src/models/circle_member.rs**
10. **backend/src/models/patient_profile.rs**
11. **backend/src/models/notification.rs**

## 第三阶段：服务层实现（优先级：高）

### 需要创建的服务文件：

1. **backend/src/services/department_service.rs**
2. **backend/src/services/article_service.rs**
3. **backend/src/services/video_service.rs**
4. **backend/src/services/patient_group_service.rs**
5. **backend/src/services/live_stream_service.rs**
6. **backend/src/services/circle_service.rs**
7. **backend/src/services/notification_service.rs**
8. **backend/src/services/statistics_service.rs**

## 第四阶段：控制器层实现（优先级：高）

### 需要创建的控制器文件：

1. **backend/src/controllers/department_controller.rs**
2. **backend/src/controllers/article_controller.rs**
3. **backend/src/controllers/video_controller.rs**
4. **backend/src/controllers/patient_group_controller.rs**
5. **backend/src/controllers/live_stream_controller.rs**
6. **backend/src/controllers/circle_controller.rs**
7. **backend/src/controllers/statistics_controller.rs**

## 第五阶段：路由配置（优先级：高）

### 需要创建的路由文件：

1. **backend/src/routes/department.rs**
2. **backend/src/routes/article.rs**
3. **backend/src/routes/video.rs**
4. **backend/src/routes/patient_group.rs**
5. **backend/src/routes/live_stream.rs**
6. **backend/src/routes/circle.rs**
7. **backend/src/routes/statistics.rs**

## 第六阶段：中间件和工具（优先级：中）

### 需要实现的功能：

1. **敏感词过滤中间件**
   - backend/src/middleware/content_filter.rs

2. **文件上传处理**
   - backend/src/utils/file_upload.rs

3. **二维码生成**
   - backend/src/utils/qr_code.rs

4. **统计计算工具**
   - backend/src/utils/statistics.rs

## 第七阶段：测试实现（优先级：中）

### 需要创建的测试文件：

1. **集成测试**
   - tests/integration/test_article.rs
   - tests/integration/test_video.rs
   - tests/integration/test_live_stream.rs
   - tests/integration/test_circle.rs

2. **单元测试**
   - 在每个新创建的服务文件中添加单元测试

## 实施顺序建议

### Week 1-2: 基础功能
1. 执行数据库迁移
2. 实现科室管理（Department）
3. 实现内容管理基础（Article）
4. 实现患者分组（PatientGroup）

### Week 3: 核心功能
1. 完善直播功能（LiveStream）
2. 实现就诊人管理（PatientProfile）
3. 实现基础统计功能

### Week 4: 互动功能
1. 实现圈子社区（Circle）
2. 实现患者评价（PatientReview）
3. 实现通知系统（Notification）

### Week 5: 完善和优化
1. 实现视频管理（Video）
2. 实现常用语/处方模板
3. 添加敏感词过滤
4. 完善测试覆盖

## 关键依赖添加

在 Cargo.toml 中需要添加的依赖：
```toml
# 文件处理
multer = "2.0"
image = "0.24"

# 二维码生成
qrcode = "0.13"

# 敏感词过滤
regex = "1.5"

# 统计计算
chrono-tz = "0.8"
```

## 注意事项

1. 每个新功能都需要完整的错误处理
2. 所有API都需要适当的权限控制
3. 涉及用户数据的操作都需要记录日志
4. 文件上传需要做类型和大小限制
5. 所有列表查询都需要支持分页
6. 敏感操作需要事务支持